@using System.Security.Claims
@inject WebLibrary.Pages.Shared.Utils.NotificationStatusService NotificationStatusService

@{
    var path = Context.Request.Path.Value ?? "";
    var hideNav = path.Equals("/Account/Login", StringComparison.OrdinalIgnoreCase)
               || path.Equals("/Account/Register", StringComparison.OrdinalIgnoreCase)
               || path.Equals("/Account/ForgotPassword", StringComparison.OrdinalIgnoreCase);

    var isAdmin = User.Identity?.IsAuthenticated == true
               && User.IsInRole("图书馆管理员");

    // 直接在布局里计算未读数（带保护）
    int unreadCount = 0;
    if (User?.Identity?.IsAuthenticated == true)
    {
        var userId = User.FindFirstValue("UserId");
        var role = User.FindFirstValue(ClaimTypes.Role);
        if (!string.IsNullOrEmpty(userId) && !string.IsNullOrEmpty(role))
        {
            try
            {
                unreadCount = NotificationStatusService.GetUnreadCount(userId, role);
                
            }
            catch (Exception ex)
            {
                // 可替换为 ILogger 记录日志
                Console.WriteLine("GetUnreadCount error: " + ex.Message);
                unreadCount = 0;
            }
        }
    }
    
    var currentPath = path.ToLowerInvariant();
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - WebLibrary</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/WebLibrary.styles.css" asp-append-version="true" />
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

</head>
<body class="@(ViewData["BodyClass"])">
    @if (!hideNav)
    {
        <header>
            <nav class="navbar navbar-expand-sm navbar-light bg-white border-bottom box-shadow mb-3">
                <div class="container">
                    <a class="navbar-brand" asp-area="" asp-page="/Index">
                        <img src="~/images/logo.png" asp-append-version="true" alt="WebLibrary Logo" />
                        <img src="~/images/title.png" asp-append-version="true" alt="WebLibrary Title" />
                    </a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse"
                            aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarCollapse">
                        <ul class="navbar-nav gnav flex-grow-1">
                            <li class="nav-item">
                                <a class="nav-link gnav-link @(currentPath == "/home" ? "active" : null)" asp-area="" asp-page="/home"><span>主页</span></a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link gnav-link @(currentPath.StartsWith("/account") ? "active" : null)" asp-area="" asp-page="/Profile/Index"><span>个人中心</span></a>
                            </li>
                            <!-- 控制台导航项：使用上面定义的isAdmin变量 -->
                            <li class="nav-item">
                                @if (isAdmin)
                                {
                                    <a class="nav-link gnav-link @(currentPath.StartsWith("/admin") ? "active" : null)" asp-area="" asp-page="/Admin/Dashboard"><span>控制台</span></a>
                                }
                                else
                                {
                                    <a class="nav-link gnav-link" href="javascript:showAdminWarning()"><span>控制台</span></a>
                                }
                            </li>
                            <li class="nav-item">
                                <a class="nav-link gnav-link @((currentPath == "/books/search" || currentPath.StartsWith("/books/search")) ? "active" : null)" asp-area="" asp-page="/Books/Search"><span>图书检索</span></a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link gnav-link @(currentPath.StartsWith("/borrow") ? "active" : null)" asp-area="" asp-page="/Borrow/Dashboard"><span>借阅</span></a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link gnav-link @(currentPath.StartsWith("/review") ? "active" : null)" asp-area="" asp-page="/Review/Index"><span>评论</span></a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link gnav-link @(currentPath.StartsWith("/list") ? "active" : null)" asp-area="" asp-page="/List/HotBookList"><span>热门榜</span></a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link gnav-link @(currentPath.StartsWith("/lecture") ? "active" : null)" asp-area="" asp-page="/Lecture/LectureActivities"><span>讲座活动</span></a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link gnav-link @(currentPath.StartsWith("/guide") ? "active" : null)" asp-area="" asp-page="/Guide/Index"><span>指南</span></a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link gnav-link @(currentPath.StartsWith("/settings") ? "active" : null)" asp-area="" asp-page="/Settings/Settings"><span>设置</span></a>
                            </li>
                            <li class="nav-item">
                                <a href="/Notification/ReceivedNotifications" class="nav-link gnav-bell position-relative me-3">
                                    <i class="bi bi-bell" style="font-size: 1.4rem;"></i>
                                    
                                    @if (unreadCount > 0)
                                    {
                                        
                                        <span class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle">
                                            <span class="visually-hidden">有未读通知</span>
                                        </span>
                                    }
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
            <div class="navbar-extend"></div>
        </header>
    }

    @if (((ViewData["BodyClass"]?.ToString()) ?? string.Empty).Contains("home-page"))
    {
        <div class="container-fluid p-0">
            <main role="main">
                @RenderBody()
            </main>
        </div>
    }
    else
    {
        <div class="container">
            <!-- 消息显示区域 -->
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
                    <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }
            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
                    <i class="bi bi-exclamation-triangle"></i> @TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }
            @if (TempData["InfoMessage"] != null)
            {
                <div class="alert alert-info alert-dismissible fade show mt-3" role="alert">
                    <i class="bi bi-info-circle"></i> @TempData["InfoMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }
            @if (TempData["WarningMessage"] != null)
            {
                <div class="alert alert-warning alert-dismissible fade show mt-3" role="alert">
                    <i class="bi bi-exclamation-triangle"></i> @TempData["WarningMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }
            
            <main role="main" class="pb-3">
                @RenderBody()
            </main>
        </div>
    }

    <footer class="border-top footer text-muted">
        <div class="container">
            &copy; 2025 - WebLibrary - <a asp-area="" asp-page="/Privacy">Privacy</a>
        </div>
    </footer>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script src="~/js/notify.js" asp-append-version="true"></script>

    <script>
        function showAdminWarning() {
            const modalHtml = `
                <div class="modal fade show" id="adminWarningModal" style="display: block;" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title text-warning">
                                    <i class="bi bi-exclamation-triangle"></i> 权限不足
                                </h5>
                                <button type="button" class="btn-close" onclick="closeWarningModal()"></button>
                            </div>
                            <div class="modal-body">
                                <p>仅图书馆管理员可访问控制台。</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" onclick="closeWarningModal()">确定</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-backdrop fade show"></div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeWarningModal() {
            const modal = document.getElementById('adminWarningModal');
            const backdrop = document.querySelector('.modal-backdrop');
            if (modal) modal.remove();
            if (backdrop) backdrop.remove();
        }
    </script>

    @await RenderSectionAsync("Scripts", required: false)
    @await RenderSectionAsync("NotifyScripts", required: false)
</body>
</html>