@page
@model WebLibrary.Pages.Admin.NotificationManagementModel
@{
    ViewData["Title"] = "通知管理";
}

<section class="section-full">
    <div class="section-inner">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h4 text-primary mb-0"><i class="bi bi-megaphone-fill me-2"></i>发送通知</h1>
                <small class="text-muted">选择接收对象并发送系统通知（支持全员 / 按角色 / 指定用户）</small>
            </div>

            <div>
                <a asp-page="./NotificationHistory" class="btn btn-outline-secondary me-2">
                    <i class="bi bi-clock-history me-1"></i> 历史记录
                </a>
            </div>
        </div>

        <!-- 白色卡片：表单将填满该卡片的可用宽度 -->
        <div class="white-rectangle">
            <div class="rectangle-content">
                <form method="post" id="notifyForm" novalidate>
                    <div class="mb-4">
                        <label class="form-label d-block">接收类型</label>
                        <div class="d-flex gap-3 align-items-center flex-wrap">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" id="toAll" name="TargetType" value="All" checked>
                                <label class="form-check-label" for="toAll">
                                    <i class="bi bi-people-fill text-primary me-1"></i> 所有人
                                </label>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input" type="radio" id="toRole" name="TargetType" value="Role">
                                <label class="form-check-label" for="toRole">
                                    <i class="bi bi-briefcase-fill text-primary me-1"></i> 角色
                                </label>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input" type="radio" id="toUser" name="TargetType" value="User">
                                <label class="form-check-label" for="toUser">
                                    <i class="bi bi-person-fill text-primary me-1"></i> 指定用户
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- 使用完整行列布局以填满卡片宽度 -->
                    <div class="row g-3 mb-3">
                        <!-- 选择角色（整行或半行显示，视屏幕宽度而定） -->
                        <div class="col-12 col-md-6" id="roleSelectContainer" style="display:none;">
                            <label class="form-label">选择角色</label>
                            <select class="form-select" name="Role" id="roleSelect" aria-label="选择角色">
                                @foreach (var r in Model.Roles)
                                {
                                    <option value="@r">@r</option>
                                }
                            </select>
                        </div>

                        <!-- 指定用户（接收人姓名），同样占据列宽 -->
                        <div class="col-12 col-md-6" id="userInputContainer" style="display:none;">
                            <label class="form-label">接收人姓名</label>
                            <input class="form-control" name="ReceiverName" id="receiverName" value="@Model.ReceiverName" placeholder="请输入接收人姓名" />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">通知内容</label>
                        <textarea class="form-control" name="Content" id="content" rows="6" required
                                  placeholder="请输入通知内容，500字以内（必填）"></textarea>
                        <div class="form-text">可包含提醒、活动信息或系统公告。</div>
                    </div>

                    <!-- 按钮：在大屏横排，在小屏堆叠且撑满宽度 -->
                    <div class="d-flex gap-2 flex-wrap">
                        <button type="submit" class="btn btn-primary d-inline-flex align-items-center">
                            <i class="bi bi-send me-1"></i> 发送
                        </button>

                        <button type="button" id="previewBtn" class="btn btn-outline-secondary d-inline-flex align-items-center">
                            <i class="bi bi-eye me-1"></i> 预览
                        </button>

                        <button type="reset" class="btn btn-link text-muted">重置</button>
                    </div>
                </form>
            </div>
        </div>

        @if (TempData["Message"] != null)
        {
            <div class="mt-3">
                <div class="alert alert-success d-flex align-items-center" role="alert">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <div>@TempData["Message"]</div>
                </div>
            </div>
        }

        <!-- 预览模态框（保持不变） -->
        <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-megaphone-fill me-2"></i> 通知预览</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-2 small text-muted">接收对象： <span id="previewTarget">所有人</span></div>
                        <div class="white-rectangle p-3">
                            <div id="previewContent" class="content-body"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        <button type="button" id="previewSend" class="btn btn-primary">确认发送</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    /* 卡片填满与内部元素占满宽度的样式调整 */
    .white-rectangle {
        background: #fff;
        border-radius: 0.6rem;
        box-shadow: 0 6px 18px rgba(23,43,77,0.06);
        width: 100%; /* 确保卡片本身占满容器 */
    }

    .rectangle-content {
        padding: 1.25rem; /* 稍微加大内边距，使内容不显得拥挤 */
        width: 100%;
        display: block;
    }

        /* 让表单控件自然撑满列宽（Bootstrap 的 col-* 已处理，但这里确保没有意外限制） */
        .rectangle-content .form-control,
        .rectangle-content .form-select,
        .rectangle-content textarea {
            width: 100%;
        }

    .content-body {
        white-space: pre-wrap;
        word-break: break-word;
        color: #1f2937;
        line-height: 1.6;
        background: #f8fafc;
        padding: 0.75rem;
        border-radius: 0.5rem;
        border: 1px solid #eef2f7;
    }

    
</style>

@section Scripts {
    <script>
        (function () {
            const toAll = document.getElementById('toAll');
            const toRole = document.getElementById('toRole');
            const toUser = document.getElementById('toUser');
            const roleSelectContainer = document.getElementById('roleSelectContainer');
            const userInputContainer = document.getElementById('userInputContainer');

            function toggleInputs() {
                if (toRole.checked) {
                    roleSelectContainer.style.display = 'block';
                    userInputContainer.style.display = 'none';
                } else if (toUser.checked) {
                    roleSelectContainer.style.display = 'none';
                    userInputContainer.style.display = 'block';
                } else {
                    roleSelectContainer.style.display = 'none';
                    userInputContainer.style.display = 'none';
                }
            }

            // 绑定事件
            [toAll, toRole, toUser].forEach(el => el.addEventListener('change', toggleInputs));
            toggleInputs();

            // 预览逻辑
            const previewBtn = document.getElementById('previewBtn');
            const previewModalEl = document.getElementById('previewModal');
            const previewTarget = document.getElementById('previewTarget');
            const previewContent = document.getElementById('previewContent');
            const previewSend = document.getElementById('previewSend');
            const form = document.getElementById('notifyForm');

            // bootstrap modal
            const previewModal = new bootstrap.Modal(previewModalEl, { backdrop: 'static' });

            previewBtn.addEventListener('click', function () {
                const content = document.getElementById('content').value.trim();
                if (!content) {
                    alert('请输入通知内容后再预览。');
                    return;
                }

                // 计算接收对象描述
                let targetDesc = '所有人';
                if (toRole.checked) {
                    const sel = document.getElementById('roleSelect');
                    targetDesc = '角色：' + (sel ? sel.value : '');
                } else if (toUser.checked) {
                    const rn = document.getElementById('receiverName');
                    targetDesc = '用户：' + (rn ? rn.value || '(未填写姓名)' : '(未填写姓名)');
                }
                previewTarget.textContent = targetDesc;

                // 填充内容（自动转义 — 为了安全只替换换行）
                previewContent.innerText = content;
                previewModal.show();
            });

            // 点击预览模态中的“确认发送” -> 提交表单
            previewSend.addEventListener('click', function () {
                previewModal.hide();
                // 触发表单提交（直接提交）
                form.submit();
            });

            // 支持 Enter 快捷键在 textarea 中按 Ctrl+Enter 提交
            document.getElementById('content').addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    form.submit();
                }
            });
        })();
    </script>
}
