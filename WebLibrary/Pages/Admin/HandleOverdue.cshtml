@page
@model WebLibrary.Pages.Admin.HandleOverdueModel
@{
    ViewData["Title"] = "逾期图书归还";
}

<div class="container mt-5">
    <div class="row">
        <div class="col-md-12">
            <h2 class="mb-4">逾期图书处理</h2>

            @if (TempData["SuccessMessage"] != null)
            {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                    @TempData["SuccessMessage"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
            }

            @if (!ModelState.IsValid)
            {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <h5 class="alert-heading">请修正以下错误：</h5>
                        <div asp-validation-summary="All" class="mb-0"></div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
            }
        </div>
    </div>

    <div class="row">
        <!-- 逾期记录列表 -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">逾期未还图书列表</h5>
                </div>
                <div class="card-body p-0">
                    @if (Model.OverdueRecords.Any())
                    {
                            <div class="table-responsive">
                                <table class="table table-hover table-striped mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>借阅ID</th>
                                            <th>图书信息</th>
                                            <th>借阅人</th>
                                            <th>借阅日期</th>
                                            <th>应还日期</th>
                                            <th>逾期天数</th>
                                            <th>预估罚款</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    @foreach (var record in Model.OverdueRecords)
                                    {
                                                <tr class="@(record.OverdueDays > 30 ? "table-danger" : "")" 
                                                    onclick="selectRecord(@record.RecordId, @record.EstimatedFine)">
                                                    <td>@record.RecordId</td>
                                                    <td>
                                                        <div class="fw-bold">@record.BookTitle</div>
                                                        <div class="text-muted small">图书编号: @record.BookId</div>
                                                    </td>
                                                    <td>@record.UserName (ID: @record.UserId)</td>
                                                    <td>@record.BorrowDate.ToString("yyyy-MM-dd")</td>
                                                    <td>@record.DueDate.ToString("yyyy-MM-dd")</td>
                                                    <td class="fw-bold text-danger">@record.OverdueDays 天</td>
                                                    <td class="fw-bold">@record.EstimatedFine.ToString("C")</td>
                                                </tr>
                                    }
                                    </tbody>
                                </table>
                            </div>
                    }
                    else
                    {
                            <div class="text-center py-5">
                                <i class="bi bi-check-circle-fill text-success fs-1"></i>
                                <h4 class="mt-3">当前没有逾期未还的图书</h4>
                                <p class="text-muted">所有图书都已按时归还</p>
                            </div>
                    }
                </div>
                <div class="card-footer text-muted">
                    共 @Model.OverdueRecords.Count 条逾期记录
                </div>
            </div>
        </div>

        <!-- 处理表单 -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">记录归还与罚款</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        <div class="mb-3">
                            <label asp-for="Input.RecordId" class="form-label fw-bold">借阅记录ID</label>
                            <input asp-for="Input.RecordId" class="form-control" id="recordIdInput" readonly>
                            <span asp-validation-for="Input.RecordId" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Input.ActualReturnDate" class="form-label fw-bold">实际归还日期</label>
                            <input asp-for="Input.ActualReturnDate" class="form-control" type="date">
                            <span asp-validation-for="Input.ActualReturnDate" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Input.FineAmount" class="form-label fw-bold">
                                罚款金额 <span id="estimatedFine" class="text-muted"></span>
                            </label>
                            <input asp-for="Input.FineAmount" class="form-control">
                            <span asp-validation-for="Input.FineAmount" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Input.Remarks" class="form-label fw-bold">备注</label>
                            <textarea asp-for="Input.Remarks" class="form-control" rows="3" 
                                      placeholder="输入处理备注（可选）"></textarea>
                            <span asp-validation-for="Input.Remarks" class="text-danger"></span>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-check-circle me-2"></i>确认归还并记录罚款
                        </button>
                    </form>
                </div>
            </div>

            <!-- 操作指南 -->
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">操作指南</h6>
                </div>
                <div class="card-body small">
                    <ol class="mb-0">
                        <li>在左侧列表中选择要处理的逾期记录</li>
                        <li>检查自动填充的借阅ID和预估罚款</li>
                        <li>确认实际归还日期（默认为今天）</li>
                        <li>输入实际收取的罚款金额</li>
                        <li>如有需要，添加备注信息</li>
                        <li>点击"确认归还并记录罚款"完成操作</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
        <partial name="_ValidationScriptsPartial" />
        <script>
            function selectRecord(recordId, estimatedFine) {
                document.getElementById('recordIdInput').value = recordId;

                const fineInput = document.querySelector('input[name="Input.FineAmount"]');
                fineInput.value = estimatedFine.toFixed(2);

                document.getElementById('estimatedFine').textContent = 
                    `(预估: ${estimatedFine.toFixed(2)}元)`;

                // 高亮选中的行
                document.querySelectorAll('tr').forEach(row => {
                    row.classList.remove('table-active');
                });
                event.currentTarget.classList.add('table-active');
            }

            // 默认选中第一条记录（如果有）
        @if (Model.OverdueRecords.Any())
        {
            var firstRecord = Model.OverdueRecords.First();
            <text>
                    window.onload = function() {
                        selectRecord(@firstRecord.RecordId, @firstRecord.EstimatedFine);
                        document.querySelector('tr:first-child').classList.add('table-active');
                    };
            </text>
        }
        </script>

        <style>
            tr {
                cursor: pointer;
                transition: background-color 0.2s;
            }
            tr:hover {
                background-color: rgba(13, 110, 253, 0.05) !important;
            }
            tr.table-active {
                background-color: rgba(13, 110, 253, 0.15) !important;
            }
            .card-header {
                padding: 1rem 1.5rem;
            }
            .table th {
                background-color: #f8f9fa;
            }
        </style>
}