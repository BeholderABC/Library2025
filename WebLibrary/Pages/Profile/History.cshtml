@page
@using System.Text.Json
@model WebLibrary.Pages.Profile.ProfileModel
@{
  int pageSize = 4;
  int totalBooks = Model.HistoryBooks?.Count ?? 0;
  int currentPage = 1;

  var InterestJson = JsonSerializer.Serialize(
      Model.InterestCates
          .Where(kvp => kvp.Value != 0)
          .Select(kvp => new { name = kvp.Key, value = kvp.Value })
          .ToList()
  );
}

<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å€Ÿé˜…å†å²</title>
  <link rel="stylesheet" href="/css/profile.css">
  <!-- æ·»åŠ  å›¾è¡¨ å¼•ç”¨ -->
  <script src="/js/rose.js"></script>
  <style>
  </style>
</head>

<body>
  <div class="library-profile-container">
    <div class="wrap">
      <partial name="_SpaceCover" />

      <div class="main">
        <div class="card">
          <partial name="_SpaceNav" />
          <!-- ç©ºçŠ¶æ€ -->
          @if (totalBooks == 0)
          {
            <div class="empty-state" id="emptyState">
              <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“š</div>
              <div style="font-size: 16px;">æš‚æ— å€Ÿé˜…è®°å½•ï¼Œå¿«å»å€Ÿé˜…æ‚¨æ„Ÿå…´è¶£çš„å›¾ä¹¦å§ï¼</div>
            </div>
          }
          <div class="history-section">
            <!-- å€Ÿé˜…è®°å½•åˆ—è¡¨ -->
            <div class="history-list-container">
              @if (totalBooks != 0)
              {
                // ç”Ÿæˆæ‰€æœ‰å›¾ä¹¦ï¼Œä½†é»˜è®¤éšè—
                <div class="history-list" id="historyList">
                @for (int i = 0; i < totalBooks; i++)
                {
                  var book = Model.HistoryBooks[i];
                  <div class="history-item" onclick="viewBookDetails(@book.BookID)">
                    <div class="book-cover">
                      <img src="@book.CoverUrl" alt="@book.Title" />
                    </div>
                    <div class="book-details">
                      <div class="book-title">@book.Title</div>
                      <div class="book-author">@book.Author</div>
                      <div class="borrow-info">@book.BorrowDate è‡³ @book.DueDate</div>
                    </div>
                    <div class="status-section">
                      @if (book.Status == "reserved") {
                        <div class="status-badge status-reserved">é¢„çº¦ä¸­</div>
                        @if (book.BorrowTimeSpan.Days > 0) {
                          <div class="time-info">ç­‰å¾… @book.BorrowTimeSpan.Days å¤©</div>
                        }
                        else {
                          <div class="time-info">ä»Šæ—¥å¯å–</div>
                        }
                      }
                      else if (book.Status == "lending") {
                        <div class="status-badge status-reading">é˜…è¯»ä¸­</div>
                        @if (book.BorrowTimeSpan.Days > 0) {
                          <div class="time-info">å‰©ä½™ @book.BorrowTimeSpan.Days å¤©</div>
                        }
                        else if (book.BorrowTimeSpan.Hours > 0)  {
                          <div class="time-info">å‰©ä½™ @book.BorrowTimeSpan.Hours å°æ—¶</div>
                        }
                        else if (book.BorrowTimeSpan.Minutes > 0)  {
                          <div class="time-info">å‰©ä½™ @book.BorrowTimeSpan.Minutes åˆ†é’Ÿ</div>
                        }
                      }
                      else if (book.Status == "returned") {
                        <div class="status-badge status-returned">å·²å½’è¿˜</div>
                        <div class="status-badge status-returned">å·²æŒ‰æœŸå½’è¿˜</div>
                      }
                      else if (book.Status == "overdue") {
                        <div class="status-badge status-overdue">å·²é€¾æœŸ</div>
                        @if (book.BorrowTimeSpan.Days > 0) {
                          <div class="time-info">é€¾æœŸ @book.BorrowTimeSpan.Days å¤©</div>
                        }
                        else if (book.BorrowTimeSpan.Hours > 0)  {
                          <div class="time-info">é€¾æœŸ @book.BorrowTimeSpan.Hours å°æ—¶</div>
                        }
                        else if (book.BorrowTimeSpan.Minutes > 0)  {
                          <div class="time-info">é€¾æœŸ @book.BorrowTimeSpan.Minutes åˆ†é’Ÿ</div>
                        }
                      }
                    </div>
                  </div>
                }
                </div>
              }
              <!-- <div class="history-list" id="historyList">
                <div class="history-item" onclick="viewBookDetails('1')">
                  <div class="book-cover">
                    <img src="https://via.placeholder.com/50x70/4f46e5/ffffff?text=ç®—æ³•" alt="ä¹¦ç±å°é¢">
                  </div>
                  <div class="book-details">
                    <div class="book-title">ç®—æ³•å¯¼è®ºï¼ˆåŸä¹¦ç¬¬3ç‰ˆï¼‰</div>
                    <div class="book-author">Thomas H. Cormen ç­‰è‘—</div>
                    <div class="borrow-info">å€Ÿé˜…ï¼š2024-08-15 â†’ åº”è¿˜ï¼š2024-09-15</div>
                  </div>
                  <div class="status-section">
                    <div class="status-badge status-reading">é˜…è¯»ä¸­</div>
                    <div class="time-info">å‰©ä½™12å¤©</div>
                  </div>
                </div>
                
                <div class="history-item" onclick="viewBookDetails('2')">
                  <div class="book-cover">
                    <img src="https://via.placeholder.com/50x70/059669/ffffff?text=è®¾è®¡" alt="ä¹¦ç±å°é¢">
                  </div>
                  <div class="book-details">
                    <div class="book-title">è®¾è®¡å¿ƒç†å­¦</div>
                    <div class="book-author">å”çº³å¾·Â·AÂ·è¯ºæ›¼</div>
                    <div class="borrow-info">å€Ÿé˜…ï¼š2024-07-20 â†’ å½’è¿˜ï¼š2024-08-10</div>
                  </div>
                  <div class="status-section">
                    <div class="status-badge status-returned">å·²å½’è¿˜</div>
                    <div class="time-info">æŒ‰æ—¶å½’è¿˜</div>
                  </div>
                </div>
                
                <div class="history-item" onclick="viewBookDetails('3')">
                  <div class="book-cover">
                    <img src="https://via.placeholder.com/50x70/dc2626/ffffff?text=JS" alt="ä¹¦ç±å°é¢">
                  </div>
                  <div class="book-details">
                    <div class="book-title">JavaScriptæƒå¨æŒ‡å—ï¼ˆç¬¬7ç‰ˆï¼‰</div>
                    <div class="book-author">David Flanagan</div>
                    <div class="borrow-info">å€Ÿé˜…ï¼š2024-06-10 â†’ åº”è¿˜ï¼š2024-07-10</div>
                  </div>
                  <div class="status-section">
                    <div class="status-badge status-overdue">å·²é€¾æœŸ</div>
                    <div class="time-info">é€¾æœŸ5å¤©</div>
                  </div>
                </div>
                
                <div class="history-item" onclick="viewBookDetails('4')">
                  <div class="book-cover">
                    <img src="https://via.placeholder.com/50x70/f59e0b/ffffff?text=AI" alt="ä¹¦ç±å°é¢">
                  </div>
                  <div class="book-details">
                    <div class="book-title">äººå·¥æ™ºèƒ½ï¼šä¸€ç§ç°ä»£çš„æ–¹æ³•</div>
                    <div class="book-author">Stuart Russell, Peter Norvig</div>
                    <div class="borrow-info">é¢„çº¦ï¼š2024-08-25 â†’ é¢„è®¡å¯å€Ÿï¼š2024-09-01</div>
                  </div>
                  <div class="status-section">
                    <div class="status-badge status-reserved">é¢„çº¦ä¸­</div>
                    <div class="time-info">3å¤©åå¯å€Ÿ</div>
                  </div>
                </div>
              </div> -->
              
            </div>
            <!-- å›¾è¡¨ -->
            @if (totalBooks != 0)
            {
              <div class="chart-container">
                <div id="readingChart"></div>
              </div>
            }
          </div>
          <!-- åˆ†é¡µç»„ä»¶ -->
          <!-- åˆ†é¡µæŒ‰é’®å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
          @if (totalBooks > 0)
          {
            <div class="pagination" id="paginationContainer"></div>
          }
        </div>
      </div>
    </div>
  </div>

  <partial name="_SpaceAvatar" />

<script>
  // å›¾è¡¨åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', function() {
    var chartDom = document.getElementById('readingChart');
    var myChart = echarts.init(chartDom);
    
    // var readingData = [
    //   { value: 25, name: 'æ–‡å­¦å°è¯´' },
    //   { value: 35, name: 'æŠ€æœ¯ç¼–ç¨‹' },
    //   { value: 15, name: 'å†å²äººæ–‡' },
    //   { value: 20, name: 'ç§‘å­¦ç§‘æ™®' },
    //   { value: 10, name: 'è‰ºæœ¯è®¾è®¡' },
    //   { value: 8, name: 'ç»æµç®¡ç†' },
    //   { value: 12, name: 'å“²å­¦å®—æ•™' }
    // ];
    var readingData = @Html.Raw(InterestJson);
    
    var option = {
      title: {
        text: 'é˜…è¯»åå¥½',
        left: 'center'
      },
      tooltip: {
        trigger: 'item',
        formatter: '{a} <br/>{b} : {c} ({d}%)'
      },
      legend: {
        left: 'right',
        top: 'center',
        orient: 'vertical'
      },
      toolbox: {
        show: true,
        feature: {
          mark: { show: true },
          dataView: { show: true, readOnly: false },
          restore: { show: true },
          saveAsImage: { show: true }
        }
      },
      series: [
        {
          name: 'Radius Mode',
          type: 'pie',
          radius: [30, 120],
          center: ['37.5%', '50%'],
          roseType: 'radius',
          itemStyle: {
            borderRadius: 5
          },
          label: {
            show: false
          },
          labelLine: {
            show: false
          },
          emphasis: {
            label: {
              show: true
            }
            // labelLine: {
            //   show: false
            // }
          },
          data: readingData,
        }
      ]
    };
    
    myChart.setOption(option);
    
    window.addEventListener('resize', function() {
      myChart.resize();
    });
  });
  
  // åˆ†é¡µåŠŸèƒ½
  let currentPage = 1;
  let totalPages = 3;
  
  function viewBookDetails(bookId) {
    console.log('æŸ¥çœ‹å›¾ä¹¦è¯¦æƒ…:', bookId);
    // window.location.href = `/Books/BookDetail?id=${bookId}`
    window.location.href = `/Borrow/Dashboard`
  }
  
    // åˆå§‹åŒ–å†å²é¡µé¢
  function initializeHistory() {
    const totalBooks = @totalBooks;
    const pageSize = @pageSize;
    const initialPage = @currentPage;
    
    if (totalBooks > 0) {
      // åˆ›å»ºåˆ†é¡µå®ä¾‹
      bookPagination = new Pagination({
        containerId: 'paginationContainer',
        itemsSelector: '.library-profile-container .history-item',
        pageSize: pageSize,
        totalItems: totalBooks,
        pagedContainer: 'historyList',
        initialPage: initialPage,
        pageParam: 'page',
        onPageChange: function(page, pagination) {
          const url = new URL(window.location);
          url.searchParams.set('page', page);
          window.history.pushState({}, '', url);
        },
        onInitialize: function(pagination) {
          console.log('åˆ†é¡µç»„ä»¶åˆå§‹åŒ–å®Œæˆ', pagination.getStatus());
        }
      });
    }
  }

  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', initializeHistory);

  // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
  window.addEventListener('beforeunload', () => {
    if (bookPagination) {
      bookPagination.destroy();
    }
  });
  
</script>
</body>
</html>