@page
@model WebLibrary.Pages.Lecture.AddLectureModel
@{
    ViewData["Title"] = "新增活动";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="text-primary">新增活动</h4>
    <a asp-page="/Lecture/LectureManagement" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> 返回活动管理
    </a>
</div>

@if (!ViewData.ModelState.IsValid)
{
    <div class="alert alert-danger">
        <ul class="mb-0">
            @foreach (var modelError in ViewData.ModelState.Values.SelectMany(v => v.Errors))
            {
                <li>@modelError.ErrorMessage</li>
            }
        </ul>
    </div>
}

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="addLectureForm">
                    <div class="mb-3">
                        <label asp-for="Lecture.Name" class="form-label">活动名称 <span class="text-danger">*</span></label>
                        <input asp-for="Lecture.Name" class="form-control" placeholder="请输入活动名称" required />
                        <span asp-validation-for="Lecture.Name" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Lecture.Speaker" class="form-label">主讲人 <span class="text-danger">*</span></label>
                        <input asp-for="Lecture.Speaker" class="form-control" placeholder="请输入主讲人姓名" required />
                        <span asp-validation-for="Lecture.Speaker" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Lecture.LectureDate" class="form-label">活动日期 <span class="text-danger">*</span></label>
                        <input asp-for="Lecture.LectureDate" type="datetime-local" class="form-control" id="lectureDate" required />
                        <span asp-validation-for="Lecture.LectureDate" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Lecture.Summary" class="form-label">活动简介</label>
                        <textarea asp-for="Lecture.Summary" class="form-control" rows="4" 
                                  placeholder="请输入活动简介（可选）"></textarea>
                        <span asp-validation-for="Lecture.Summary" class="text-danger"></span>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="Lecture.MaxNum" class="form-label">最大人数 <span class="text-danger">*</span></label>
                                <input asp-for="Lecture.MaxNum" type="number" class="form-control" 
                                       placeholder="请输入最大人数" min="1" max="1000" required />
                                <div class="form-text">设置活动可容纳的最大人数</div>
                                <span asp-validation-for="Lecture.MaxNum" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="Lecture.NowNum" class="form-label">当前人数 <span class="text-danger">*</span></label>
                                <input asp-for="Lecture.NowNum" type="number" class="form-control" 
                                       placeholder="请输入当前人数" min="0" max="1000" required />
                                <div class="form-text">当前已报名的人数</div>
                                <span asp-validation-for="Lecture.NowNum" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="pictureFile" class="form-label">活动图片</label>
                        <input type="file" id="pictureFile" name="pictureFile" class="form-control" 
                               accept="image/*" onchange="previewImage(this)" />
                        <div class="form-text">支持 JPG、PNG、GIF 格式，建议尺寸 800x600 像素</div>
                        <div id="imagePreview" class="mt-2" style="display: none;">
                            <img id="previewImg" class="img-thumbnail" style="max-height: 200px;" />
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a asp-page="/Lecture/LectureManagement" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> 取消
                        </a>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="bi bi-check-circle"></i> 保存活动
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // 页面加载完成后设置日期选择器的限制
    document.addEventListener('DOMContentLoaded', function() {
        const dateInput = document.getElementById('lectureDate');
        
        // 设置最小日期为2020年1月1日
        const minDate = new Date(2020, 0, 1);
        const minDateString = minDate.toISOString().slice(0, 16);
        dateInput.min = minDateString;
        
        // 设置最大日期为当前日期后5年
        const maxDate = new Date();
        maxDate.setFullYear(maxDate.getFullYear() + 5);
        const maxDateString = maxDate.toISOString().slice(0, 16);
        dateInput.max = maxDateString;
        
        // 设置默认值为当前日期时间
        const now = new Date();
        const nowString = now.toISOString().slice(0, 16);
        dateInput.value = nowString;
        
        // 添加日期验证
        dateInput.addEventListener('change', function() {
            const selectedDate = new Date(this.value);
            const minDate = new Date(2020, 0, 1);
            const maxDate = new Date();
            maxDate.setFullYear(maxDate.getFullYear() + 5);
            
            if (selectedDate < minDate) {
                alert('活动日期不能早于2020年1月1日');
                this.value = minDate.toISOString().slice(0, 16);
            } else if (selectedDate > maxDate) {
                alert('活动日期不能晚于' + maxDate.getFullYear() + '年');
                this.value = maxDate.toISOString().slice(0, 16);
            }
        });

        // 表单提交验证
        document.getElementById('addLectureForm').addEventListener('submit', function(e) {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 保存中...';
        });
    });

    function previewImage(input) {
        const preview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        } else {
            preview.style.display = 'none';
        }
    }
</script>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
} 